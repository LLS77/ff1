name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy WireGuard
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # 创建 fly.toml 配置文件
          cat > fly.toml <<EOF
          app = "wg-${{ github.run_id }}"
          primary_region = "hkg"

          [build]
            image = "fscarmen/flyio-wireguard"

          [env]
            PEER_NAME = "client1"
            WG_PORT = "51820"
          EOF

          # 认证 Flyctl
          echo "${FLY_API_TOKEN}" | flyctl auth token || { echo "Flyctl authentication failed"; exit 1; }

          # 部署应用
          flyctl deploy --remote-only || { echo "Deployment failed"; exit 1; }

          # 获取客户端配置（添加重试逻辑）
          for i in {1..3}; do
            flyctl ssh console -C "cat /config/peer_client1.conf" && break || sleep 10
          done || { echo "Failed to retrieve client config after retries"; exit 1; }
